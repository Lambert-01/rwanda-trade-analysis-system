<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics | Rwanda Trade Intelligence Platform</title>

    <!-- Meta Tags -->
    <meta name="description" content="Advanced statistical analysis and  forecasting for Rwanda's trade data">
    <meta name="keywords" content="Rwanda, analytics, trade intelligence, forecasting, AI, statistics, NISR">
    <meta name="author" content="Rwanda Trade Intelligence Platform">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">

    <!-- External Libraries CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/analytics.css">

    <style>
        /* Enhanced Analytics Styles */
        .analytics-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0 0 1rem 0;
            color: white;
            position: relative;
            overflow: hidden;
            margin-top: -1rem;
        }

        .top-header {
            margin-bottom: 0;
            border-bottom: none;
        }

        /* Custom Modal Styles */
        .explanation-modal-overlay {
            animation: fadeIn 0.3s ease;
        }

        .explanation-modal-content {
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .explanation-modal-overlay.show {
            display: flex !important;
        }

        .analytics-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        .analytics-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin: 0.75rem 0;
            justify-items: center;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 240px;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .metric-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .metric-value {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
        }

        .metric-label {
            font-size: 0.875rem !important;
        }

        .analysis-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .analysis-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .analysis-card:hover {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .insight-list {
            list-style: none;
            padding: 0;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .insight-icon {
            color: #667eea;
            margin-top: 0.125rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .forecast-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .correlation-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .correlation-cell {
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: white;
        }

        .correlation-high { background: #dc2626; }
        .correlation-medium { background: #ea580c; }
        .correlation-low { background: #16a34a; }

        /* Enhanced Correlation Table Styles */
        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .correlation-table th,
        .correlation-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .correlation-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }

        .correlation-row-header {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            text-align: left;
            border-right: 2px solid #e5e7eb;
        }

        .correlation-cell {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        .correlation-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .correlation-high {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .correlation-medium {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }

        .correlation-low {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .correlation-diagonal {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .correlation-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: inline-block;
        }

        .legend-color.correlation-high {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .legend-color.correlation-medium {
            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
        }

        .legend-color.correlation-low {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .legend-color.correlation-diagonal {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        /* Markdown formatting styles */
        .bullet-point {
            display: block;
            margin-left: 1rem;
            color: #6b7280;
        }

        .insight-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #2563eb;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }

        .insight-content strong {
            color: #1f2937;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .analytics-metrics-grid {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .correlation-matrix {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Modern Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="assets/images/NISR.png" alt="NISR Logo" class="nisr-logo">
                <h3>Rwanda Trade Intelligence Platform</h3>
                <span class="ai-badge"></span>
            </div>
        </div>

        <div class="sidebar-menu">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="index.html" class="nav-link" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="exports.html" class="nav-link" data-page="exports">
                        <i class="fas fa-arrow-up"></i>
                        <span>Exports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="imports.html" class="nav-link" data-page="imports">
                        <i class="fas fa-arrow-down"></i>
                        <span>Imports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="predictions.html" class="nav-link" data-page="predictions">
                        <i class="fas fa-robot"></i>
                        <span>AI Predictions</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="analytics.html" class="nav-link active" data-page="analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Advanced Analytics</span>
                        <div class="nav-indicator"></div>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="commodities.html" class="nav-link" data-page="commodities">
                        <i class="fas fa-boxes"></i>
                        <span>Commodities</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="regional.html" class="nav-link" data-page="regional">
                        <i class="fas fa-globe-africa"></i>
                        <span>Regional Analysis</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-name">Trade Analyst</span>
                    <span class="user-role">NISR Analytics</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Top Header Bar -->
    <header class="top-header">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle Navigation Menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">
                <h1>Advanced Analytics Dashboard</h1>
                <p>Comprehensive statistical analysis &  insights</p>
            </div>
        </div>

        <div class="header-right">
            <div class="header-actions">
                <button class="btn btn-refresh" onclick="loadAnalyticsData()" title="Refresh Analytics Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="time-display">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Analytics Section for main.js navigation -->
        <section id="analytics" class="section">
            <!-- Loading Screen -->
            <div id="loading-screen" class="loading-screen">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <p class="loading-text">Loading Advanced Analytics...</p>
                    <small class="text-white-50">Processing comprehensive statistical analysis...</small>
                </div>
            </div>

        <!-- Hero Section -->
        <section class="analytics-hero">
            <div class="container-fluid text-center">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <h1 class="h2 fw-bold mb-2">
                            <i class="fas fa-chart-line me-2"></i>
                            Advanced Trade Analytics
                        </h1>
                        <p class="mb-3 small text-white">
                            Professional statistical analysis, forecasting, and  insights for Rwanda's trade intelligence
                        </p>
                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                            <span class="badge bg-white text-primary px-2 py-1 small">
                                <i class="fas fa-brain me-1"></i>6 Analysis Methods
                            </span>
                            <span class="badge bg-white text-success px-2 py-1 small">
                                <i class="fas fa-robot me-1"></i>
                            </span>
                            <span class="badge bg-white text-warning px-2 py-1 small">
                                <i class="fas fa-chart-bar me-1"></i>Real-time Data
                            </span>
                        </div>
                        <!-- Test Modal Button -->
                        <div class="mt-3">
                            <button class="btn btn-light btn-sm" onclick="showExplanation('time-series')" title="Test Modal">
                                <i class="fas fa-test-tube me-1"></i>Test Modal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Key Metrics Overview -->
        <section class="container-fluid py-5">
            <div class="analytics-metrics-grid" id="key-metrics">
                <!-- Metrics will be populated by JavaScript -->
            </div>
        </section>

        <!-- 1. Time Series Analysis -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-primary text-white">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Time Series Analysis</h2>
                        <p class="text-muted mb-0">Trend analysis, seasonality, and forecasting</p>
                    </div>
                    <button class="btn btn-outline-primary btn-sm explanation-btn" onclick="showExplanation('time-series')" title="Understanding Time Series Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-trending-up text-success me-2"></i>
                            Trend Analysis
                        </h5>
                        <div id="trend-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading trend data...</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-wave-square text-info me-2"></i>
                            Seasonality Analysis
                        </h5>
                        <div id="seasonality-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading seasonality data...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Forecast Analysis - Full Width Section -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-warning text-white">
                        <i class="fas fa-magic"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Trade Forecasting (Next 4 Quarters)</h2>
                        <p class="text-muted mb-0"> predictions for Rwanda's trade future</p>
                    </div>
                    <button class="btn btn-outline-warning btn-sm explanation-btn" onclick="showExplanation('forecasting')" title="Understanding Trade Forecasting">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="analysis-card" style="border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);">
                    <div id="forecast-analysis">
                        <div class="text-center py-4">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-2 text-muted">Loading forecast chart...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Growth Analysis -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-success text-white">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Comparative Growth Analysis</h2>
                        <p class="text-muted mb-0">QoQ, YoY changes, and CAGR calculations</p>
                    </div>
                    <button class="btn btn-outline-success btn-sm explanation-btn" onclick="showExplanation('growth')" title="Understanding Growth Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-percentage text-success me-2"></i>
                                Growth Insights
                            </h5>
                            <ul class="insight-list" id="growth-insights">
                                <li class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading growth insights...</p>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-calculator text-primary me-2"></i>
                                CAGR Summary
                            </h5>
                            <div id="cagr-summary">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading CAGR data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Share Analysis -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-info text-white">
                        <i class="fas fa-pie-chart"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Contribution & Share Analysis</h2>
                        <p class="text-muted mb-0">Market share analysis by country, region, and commodity</p>
                    </div>
                    <button class="btn btn-outline-info btn-sm explanation-btn" onclick="showExplanation('share')" title="Understanding Share Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-globe text-primary me-2"></i>
                            Top Export Markets
                        </h5>
                        <div id="export-share-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading export share data...</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-shopping-cart text-warning me-2"></i>
                            Top Import Sources
                        </h5>
                        <div id="import-share-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading import share data...</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-box text-success me-2"></i>
                            Commodity Shares
                        </h5>
                        <div id="commodity-share-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading commodity share data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Concentration Analysis (HHI) -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-warning text-white">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Concentration Index (HHI)</h2>
                        <p class="text-muted mb-0">Market concentration and diversification analysis</p>
                    </div>
                    <button class="btn btn-outline-warning btn-sm explanation-btn" onclick="showExplanation('hhi')" title="Understanding HHI Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-arrow-up text-success me-2"></i>
                            Export Market Concentration
                        </h5>
                        <div id="export-hhi-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading HHI data...</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-arrow-down text-danger me-2"></i>
                            Import Market Concentration
                        </h5>
                        <div id="import-hhi-analysis">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading HHI data...</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <h5 class="card-title">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Risk Assessment
                        </h5>
                        <div id="hhi-risk-assessment">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-muted">Loading risk assessment...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. Trade Balance Analysis -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-danger text-white">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Trade Balance & Structural Analysis</h2>
                        <p class="text-muted mb-0">Deficit analysis and structural trade components</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm explanation-btn" onclick="showExplanation('balance')" title="Understanding Trade Balance Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-chart-area text-danger me-2"></i>
                                Balance Trends
                            </h5>
                            <div id="balance-trends">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading balance trends...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-search-dollar text-warning me-2"></i>
                                Deficit Drivers
                            </h5>
                            <ul class="insight-list" id="deficit-drivers">
                                <li class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading deficit analysis...</p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. Correlation Analysis -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-secondary text-white">
                        <i class="fas fa-link"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="h3 mb-1">Correlation & Dependency Analysis</h2>
                        <p class="text-muted mb-0">Interrelationships between trade variables</p>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm explanation-btn" onclick="showExplanation('correlation')" title="Understanding Correlation Analysis">
                        <i class="fas fa-info-circle me-1"></i>Explain
                    </button>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-table text-primary me-2"></i>
                                Correlation Matrix
                            </h5>
                            <div id="correlation-matrix">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading correlation matrix...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="analysis-card">
                            <h5 class="card-title">
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                Key Relationships
                            </h5>
                            <ul class="insight-list" id="correlation-insights">
                                <li class="text-center py-4">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-2 text-muted">Loading correlation insights...</p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Recommendations -->
        <section class="container-fluid">
            <div class="analysis-section">
                <div class="section-header">
                    <div class="section-icon bg-primary text-white">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h2 class="h3 mb-1"> Strategic Recommendations</h2>
                        <p class="text-muted mb-0">Data-driven insights for policymakers and trade strategists</p>
                    </div>
                </div>

                <div class="analysis-grid" id="ai-recommendations">
                    <div class="analysis-card text-center py-5">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-3 text-muted">Generating AI recommendations...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Explanation Modal -->
    <div class="explanation-modal-overlay" id="explanationModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; justify-content: center; align-items: center;">
        <div class="explanation-modal-content" id="explanationModal" style="background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 900px; width: 90%; max-height: 85vh; overflow: hidden; position: relative;">
            <div class="modal-header bg-primary text-white" style="padding: 1.5rem 2rem;">
                <h5 class="modal-title" id="explanationModalLabel" style="color: black !important;">
                    <i class="fas fa-lightbulb me-2"></i>Analysis Explanation
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeExplanationModal()" aria-label="Close" style="position: absolute; right: 1.5rem; top: 1.5rem;"></button>
            </div>

            <!-- Tab Navigation -->
            <div class="modal-tabs" style="padding: 0 2rem; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                <ul class="nav nav-tabs" id="explanationTabs" role="tablist" style="border: none; margin: 0;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation-panel" type="button" role="tab" aria-controls="explanation-panel" aria-selected="true">
                            <i class="fas fa-info-circle me-1"></i>Explanation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-insights-tab" data-bs-toggle="tab" data-bs-target="#ai-insights-panel" type="button" role="tab" aria-controls="ai-insights-panel" aria-selected="false">
                            <i class="fas fa-robot me-1"></i>AI Insights
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="explanationTabContent" style="max-height: 65vh; overflow-y: auto;">
                <div class="tab-pane fade show active" id="explanation-panel" role="tabpanel" aria-labelledby="explanation-tab" style="padding: 2rem;">
                    <div id="explanationContent">
                        <!-- Explanation content will be inserted here -->
                    </div>
                </div>
                <div class="tab-pane fade" id="ai-insights-panel" role="tabpanel" aria-labelledby="ai-insights-tab" style="padding: 2rem;">
                    <div id="aiInsightsContent">
                        <div class="text-center py-4">
                            <button class="btn btn-primary mb-3" onclick="generateAIInsights()" id="generateInsightBtn">
                                <i class="fas fa-robot me-2"></i>Generate AI Insights
                            </button>
                            <div class="loading-spinner mx-auto mb-3 d-none" id="aiLoadingSpinner"></div>
                            <p class="text-muted d-none" id="aiLoadingText">Generating AI insights...</p>
                            <small class="text-muted d-none" id="aiLoadingSubtext">This may take a few seconds</small>
                            <div id="aiInsightsDisplay" class="d-none">
                                <h6 class="text-primary mb-3" style="color: black !important;">
                                    <i class="fas fa-robot me-2"></i>AI-Generated Insights
                                </h6>
                                <p class="text-muted small">Powered by xai-grok fast 4.1 - providing intelligent analysis of Rwanda's trade data</p>
                                <div class="insights-list" id="insightsList"></div>
                                <div class="mt-4 p-3 bg-light rounded" id="insightsFooter">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>Generated: <span id="generatedTime"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer" style="padding: 1rem 2rem; border-top: 1px solid #dee2e6;">
                <button type="button" class="btn btn-secondary" onclick="closeExplanationModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- External Libraries JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Custom JavaScript -->
    <script src="js/main.js"></script>

    <!-- Analytics Data Loading Script -->
    <script>
        // Global analytics data store
        let analyticsData = {};

        // Initialize time display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            const dateString = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            const el = document.getElementById('current-time');
            if (el) {
                el.textContent = `${dateString}, ${timeString}`;
            }
        }

        updateTime();
        setInterval(updateTime, 60000);

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        if (sidebarToggle && sidebar && sidebarOverlay) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                sidebarOverlay.classList.toggle('active');
            });

            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('collapsed');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Load all analytics data
        async function loadAnalyticsData() {
            console.log('ðŸš€ Loading comprehensive analytics data...');

            try {
                // Show loading screen
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'flex';
                }

                // Fetch all analytics data from API endpoints
                const endpoints = [
                    '/api/analytics/time-series',
                    '/api/analytics/growth-analysis',
                    '/api/analytics/share-analysis',
                    '/api/analytics/hhi-analysis',
                    '/api/analytics/trade-balance-analysis',
                    '/api/analytics/correlation-analysis'
                ];

                const responses = await Promise.all(
                    endpoints.map(endpoint => fetch(endpoint).catch(() => null))
                );

                const data = await Promise.all(
                    responses.map(response => response && response.ok ? response.json() : null)
                );

                // Store data globally - adjust structure to match Python output
                analyticsData = {
                    timeSeries: data[0] || null,
                    growth: data[1] || null,
                    share: data[2] || null,
                    hhi: data[3] || null,
                    tradeBalance: data[4] || null,
                    correlations: data[5] || null
                };

                console.log('ðŸ“Š Analytics data loaded:', analyticsData);

                // Add fallback data for testing if API fails
                if (!analyticsData.timeSeries) {
                    analyticsData.timeSeries = {
                        "time_series": {
                            "exports_trend": {"slope": 26.52, "intercept": 354.44, "r_squared": 0.45, "trend_values": [354, 381, 407, 434, 461, 487, 514, 540, 567]},
                            "imports_trend": {"slope": 11.31, "intercept": 944.54, "r_squared": 0.10, "trend_values": [945, 956, 967, 978, 990, 1001, 1012, 1024, 1035]},
                            "trade_deficit_trend": {"slope": 15.21, "intercept": -590.10, "r_squared": 0.33, "trend_values": [-590, -575, -560, -544, -529, -514, -499, -484, -468]},
                            "seasonal_analysis": {"exports": {"seasonal_component": [-22.6, 16.4, 35.7, -29.5, -22.6, 16.4, 35.7, -29.5, -22.6]}, "imports": {"seasonal_component": [-108.2, 44.0, 79.4, -15.2, -108.2, 44.0, 79.4, -15.2, -108.2]}},
                            "stationarity_tests": {"exports": {"stationary": true}, "imports": {"stationary": false}},
                            "forecast_next_4_quarters": {"exports": {"forecast_values": [544, 539, 529, 458]}, "imports": {"forecast_values": [999, 1062, 1006, 870]}}
                        }
                    };
                }

                if (!analyticsData.growth) {
                    analyticsData.growth = {
                        "growth_analysis": {
                            "qoq": {"exports": [0.08, 0.02, 0.01, 0.08, 0.12, 0.15, 0.15, 0.00], "imports": [0.06, 0.05, 0.03, 0.04, 0.08, 0.08, 0.07, 0.04]},
                            "yoy": {"exports": [0.16, 0.14, 0.13, 0.12, 0.11, 0.10, 0.09, 0.08], "imports": [0.07, 0.06, 0.05, 0.04, 0.03, 0.02, 0.01, 0.00]},
                            "cagr": {"exports": 0.114, "imports": -0.023},
                            "insights": ["Export growth shows positive CAGR of 11.4%", "Import growth shows negative CAGR of -2.3%", "Q4 2024 showed strongest export growth"]
                        }
                    };
                }

                if (!analyticsData.share) {
                    analyticsData.share = {
                        "share_analysis": {
                            "country_share": {
                                "exports": {"UAE": {"value": 2759.32, "share_percentage": 66.6}, "DRC": {"value": 468.45, "share_percentage": 11.3}},
                                "imports": {"China": {"value": 2678.69, "share_percentage": 30.1}, "Tanzania": {"value": 1890.48, "share_percentage": 21.2}}
                            },
                            "insights": ["UAE dominates exports with 66.6% share", "China leads imports with 30.1% share"]
                        }
                    };
                }

                if (!analyticsData.hhi) {
                    analyticsData.hhi = {
                        "hhi": {
                            "export_destinations": {"hhi_value": 0.3758, "interpretation": "Highly concentrated market", "number_of_destinations": 21},
                            "import_sources": {"hhi_value": 0.3213, "interpretation": "Highly concentrated market", "number_of_sources": 21},
                            "insights": ["Export market concentration indicates vulnerability to UAE market changes", "Import concentration suggests supply chain risks"]
                        }
                    };
                }

                if (!analyticsData.tradeBalance) {
                    analyticsData.tradeBalance = {
                        "trade_balance": {
                            "quarterly_balance": [-979, -1031, -1085, -952, -763],
                            "deficit_drivers": {"average_deficit": 962, "quarters_in_deficit": 5, "insights": ["Persistent trade deficit driven by high import volumes", "Machinery imports major contributor to deficit"]},
                            "regional_contributions": {"EAC": -163, "EU": -128, "Asia": -671}
                        }
                    };
                }

                if (!analyticsData.correlations) {
                    analyticsData.correlations = {
                        "correlations": {
                            "matrix": {"exports-imports": -0.45, "exports-time": 0.67, "imports-time": 0.32},
                            "strong_relationships": [{"variables": "exports-time", "correlation": 0.67, "interpretation": "Strong positive correlation between exports and time"}],
                            "insights": ["Exports show strong upward trend", "Imports have moderate growth pattern"]
                        }
                    };
                }

                console.log('âœ… Analytics data loaded successfully');

                // Render all sections
                renderKeyMetrics();
                renderTimeSeriesAnalysis();
                renderGrowthAnalysis();
                renderShareAnalysis();
                renderHhiAnalysis();
                renderTradeBalanceAnalysis();
                renderCorrelationAnalysis();
                renderAIRecommendations();

                console.log('âœ… All analytics sections rendered successfully');

                // Hide loading screen
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }

            } catch (error) {
                console.error('âŒ Error loading analytics data:', error);
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div class="spinner-container">
                            <div class="text-danger">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                            </div>
                            <p class="text-white mt-3">Error loading analytics data</p>
                            <small class="text-white-50">${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        // Render key metrics overview
        function renderKeyMetrics() {
            const container = document.getElementById('key-metrics');
            if (!container || !analyticsData.timeSeries) return;

            const ts = analyticsData.timeSeries.time_series;
            const quarters = ['2023Q1', '2023Q2', '2023Q3', '2023Q4', '2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1'];
            const exports = [367.63, 453.5, 349.62, 352.68, 401.18, 508.96, 626.67, 626.06, 458.44];
            const imports = [904.33, 965.41, 1002.48, 948.9, 889.52, 1078.88, 1158.24, 1090.55, 869.79];

            const latestExport = exports[exports.length - 1];
            const latestImport = imports[imports.length - 1];
            const tradeBalance = latestExport - latestImport;

            const exportChange = exports.length > 1 ? ((latestExport - exports[exports.length - 2]) / exports[exports.length - 2] * 100) : 0;
            const importChange = imports.length > 1 ? ((latestImport - imports[imports.length - 2]) / imports[imports.length - 2] * 100) : 0;

            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon bg-success text-white">
                            <i class="fas fa-arrow-trend-up"></i>
                        </div>
                        <div class="metric-trend ${exportChange >= 0 ? 'text-success' : 'text-danger'}">
                            <i class="fas fa-arrow-${exportChange >= 0 ? 'up' : 'down'}"></i>
                            <span>${Math.abs(exportChange).toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value">$${latestExport.toFixed(1)}M</h3>
                        <p class="metric-label">Latest Quarter Exports</p>
                        <div class="mt-2">
                            <small class="text-muted">CAGR: ${analyticsData.growth?.growth_analysis?.cagr?.exports ? (analyticsData.growth.growth_analysis.cagr.exports * 100).toFixed(1) : '0.0'}%</small>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon bg-primary text-white">
                            <i class="fas fa-arrow-trend-down"></i>
                        </div>
                        <div class="metric-trend ${importChange >= 0 ? 'text-success' : 'text-danger'}">
                            <i class="fas fa-arrow-${importChange >= 0 ? 'up' : 'down'}"></i>
                            <span>${Math.abs(importChange).toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value">$${latestImport.toFixed(1)}M</h3>
                        <p class="metric-label">Latest Quarter Imports</p>
                        <div class="mt-2">
                            <small class="text-muted">CAGR: ${analyticsData.growth?.growth_analysis?.cagr?.imports ? (analyticsData.growth.growth_analysis.cagr.imports * 100).toFixed(1) : '0.0'}%</small>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon bg-warning text-white">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="metric-trend text-danger">
                            <i class="fas fa-arrow-down"></i>
                            <span>Deficit</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value">$${Math.abs(tradeBalance).toFixed(1)}M</h3>
                        <p class="metric-label">Trade Balance</p>
                        <div class="mt-2">
                            <small class="text-muted">Deficit quarters: ${analyticsData.tradeBalance?.trade_balance?.deficit_drivers?.quarters_in_deficit || 0}/9</small>
                        </div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon bg-info text-white">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-trend text-primary">
                            <i class="fas fa-robot"></i>
                            <span>AI Analysis</span>
                        </div>
                    </div>
                    <div class="metric-content">
                        <h3 class="metric-value">6 Methods</h3>
                        <p class="metric-label">Advanced Analytics</p>
                        <div class="mt-2">
                            <small class="text-muted">Time Series, Growth, Share, HHI, Balance, Correlation</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render time series analysis
        function renderTimeSeriesAnalysis() {
            if (!analyticsData.timeSeries || !analyticsData.timeSeries.time_series) {
                console.error('Time series data not available:', analyticsData.timeSeries);
                // Show error message in UI
                const trendContainer = document.getElementById('trend-analysis');
                if (trendContainer) {
                    trendContainer.innerHTML = '<div class="alert alert-warning">Time series data not available. Please run the Python analytics pipeline.</div>';
                }
                return;
            }

            const ts = analyticsData.timeSeries.time_series;

            // Helper function to safely format numbers
            function safeFormat(value, decimals = 2, defaultValue = 'N/A') {
                if (value === null || value === undefined || isNaN(value)) {
                    return defaultValue;
                }
                return Number(value).toFixed(decimals);
            }

            // Trend analysis
            const trendContainer = document.getElementById('trend-analysis');
            if (trendContainer) {
                const exportsSlope = ts.exports_trend?.slope || 0;
                const importsSlope = ts.imports_trend?.slope || 0;
                const balanceSlope = ts.trade_deficit_trend?.slope || 0;
                const exportsRsquared = ts.exports_trend?.r_squared || 0;
                const importsRsquared = ts.imports_trend?.r_squared || 0;
                const balanceRsquared = ts.trade_deficit_trend?.r_squared || 0;

                trendContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Slope</th>
                                <th>RÂ²</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Exports</strong></td>
                                <td>${safeFormat(exportsSlope)}</td>
                                <td>${safeFormat((exportsRsquared * 100), 1)}%</td>
                                <td><span class="badge bg-${exportsSlope > 0 ? 'success' : 'danger'}">${exportsSlope > 0 ? 'Increasing' : 'Decreasing'}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Imports</strong></td>
                                <td>${safeFormat(importsSlope)}</td>
                                <td>${safeFormat((importsRsquared * 100), 1)}%</td>
                                <td><span class="badge bg-${importsSlope > 0 ? 'success' : 'danger'}">${importsSlope > 0 ? 'Increasing' : 'Decreasing'}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Trade Balance</strong></td>
                                <td>${safeFormat(balanceSlope)}</td>
                                <td>${safeFormat((balanceRsquared * 100), 1)}%</td>
                                <td><span class="badge bg-warning">Deficit Trend</span></td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            // Seasonality analysis
            const seasonalityContainer = document.getElementById('seasonality-analysis');
            if (seasonalityContainer) {
                seasonalityContainer.innerHTML = `
                    <div class="mb-3">
                        <h6>Stationarity Tests (ADF)</h6>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Series</th>
                                    <th>P-Value</th>
                                    <th>Stationary</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Exports</td>
                                    <td>${ts.stationarity_tests.exports.p_value.toFixed(4)}</td>
                                    <td><span class="badge bg-${ts.stationarity_tests.exports.stationary ? 'success' : 'warning'}">${ts.stationarity_tests.exports.stationary ? 'Yes' : 'No'}</span></td>
                                </tr>
                                <tr>
                                    <td>Imports</td>
                                    <td>${ts.stationarity_tests.imports.p_value.toFixed(4)}</td>
                                    <td><span class="badge bg-${ts.stationarity_tests.imports.stationary ? 'success' : 'warning'}">${ts.stationarity_tests.imports.stationary ? 'Yes' : 'No'}</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Forecast analysis - Professional Chart
            const forecastContainer = document.getElementById('forecast-analysis');
            if (forecastContainer) {
                const forecastData = ts.forecast_next_4_quarters;

                // Prepare data for chart
                const quarters = ['2023Q1', '2023Q2', '2023Q3', '2023Q4', '2024Q1', '2024Q2', '2024Q3', '2024Q4', '2025Q1'];
                const historicalExports = [367.63, 453.5, 349.62, 352.68, 401.18, 508.96, 626.67, 626.06, 458.44];
                const historicalImports = [904.33, 965.41, 1002.48, 948.9, 889.52, 1078.88, 1158.24, 1090.55, 869.79];

                // Forecast quarters and values
                const forecastQuarters = ['2026Q1', '2026Q2', '2026Q3', '2026Q4'];
                const forecastExports = forecastData.exports.forecast_values;
                const forecastImports = forecastData.imports.forecast_values;

                // Combine historical and forecast data
                const allQuarters = [...quarters, ...forecastQuarters];
                const allExports = [...historicalExports, ...forecastExports];
                const allImports = [...historicalImports, ...forecastImports];

                forecastContainer.innerHTML = `
                    <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
                        <canvas id="forecast-chart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                    <div class="mt-3 text-center">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-success mb-2">Export Forecast Summary</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="h5 text-success">${forecastExports[0].toFixed(1)}M</div>
                                            <small>Q1 2026</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 text-success">${forecastExports[3].toFixed(1)}M</div>
                                            <small>Q4 2026</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-primary mb-2">Import Forecast Summary</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="h5 text-primary">${forecastImports[0].toFixed(1)}M</div>
                                            <small>Q1 2026</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 text-primary">${forecastImports[3].toFixed(1)}M</div>
                                            <small>Q4 2026</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Create the forecast chart
                setTimeout(() => {
                    const ctx = document.getElementById('forecast-chart');
                    if (ctx && typeof Chart !== 'undefined') {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: allQuarters,
                                datasets: [{
                                    label: 'Historical Exports',
                                    data: historicalExports.concat([null, null, null, null]), // Pad with nulls for forecast
                                    borderColor: '#00A1F1',
                                    backgroundColor: 'rgba(0, 161, 241, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    pointBackgroundColor: '#00A1F1',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4
                                }, {
                                    label: 'Historical Imports',
                                    data: historicalImports.concat([null, null, null, null]), // Pad with nulls for forecast
                                    borderColor: '#FCDD09',
                                    backgroundColor: 'rgba(252, 221, 9, 0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    pointBackgroundColor: '#FCDD09',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4
                                }, {
                                    label: 'Forecasted Exports',
                                    data: [null, null, null, null, null, null, null, null, null].concat(forecastExports),
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.4,
                                    pointBackgroundColor: '#28a745',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    pointRadius: 5
                                }, {
                                    label: 'Forecasted Imports',
                                    data: [null, null, null, null, null, null, null, null, null].concat(forecastImports),
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.4,
                                    pointBackgroundColor: '#dc3545',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    pointRadius: 5
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20
                                        }
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        titleColor: '#fff',
                                        bodyColor: '#fff',
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': $' + context.parsed.y.toFixed(1) + 'M';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Quarter'
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Value (USD Million)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + (value / 1000).toFixed(1) + 'B';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            }
        }

        // Render growth analysis
        function renderGrowthAnalysis() {
            if (!analyticsData.growth || !analyticsData.growth.growth_analysis) {
                console.error('Growth analysis data not available:', analyticsData.growth);
                // Show error messages in UI
                const insightsContainer = document.getElementById('growth-insights');
                const cagrContainer = document.getElementById('cagr-summary');
                if (insightsContainer) {
                    insightsContainer.innerHTML = '<li class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-muted">Growth analysis data not available</p></li>';
                }
                if (cagrContainer) {
                    cagrContainer.innerHTML = '<div class="text-center py-4"><div class="text-muted">CAGR data not available</div></div>';
                }
                return;
            }

            const growth = analyticsData.growth.growth_analysis;

            // Helper function to safely format numbers
            function safeFormat(value, decimals = 1, defaultValue = 'N/A') {
                if (value === null || value === undefined || isNaN(value)) {
                    return defaultValue;
                }
                return Number(value).toFixed(decimals);
            }

            // Growth insights
            const insightsContainer = document.getElementById('growth-insights');
            if (insightsContainer && growth.insights) {
                insightsContainer.innerHTML = growth.insights.slice(0, 5).map(insight => `
                    <li class="insight-item">
                        <div class="insight-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="insight-content">
                            <p class="mb-0">${insight}</p>
                        </div>
                    </li>
                `).join('');
            }

            // CAGR summary
            const cagrContainer = document.getElementById('cagr-summary');
            if (cagrContainer) {
                const exportsCagr = growth.cagr?.exports || 0;
                const importsCagr = growth.cagr?.imports || 0;

                cagrContainer.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="h4 text-success">${safeFormat((exportsCagr * 100))}%</div>
                        <small class="text-muted">Exports CAGR</small>
                    </div>
                    <div class="text-center">
                        <div class="h4 text-primary">${safeFormat((importsCagr * 100))}%</div>
                        <small class="text-muted">Imports CAGR</small>
                    </div>
                `;
            }
        }

        // Render share analysis
        function renderShareAnalysis() {
            if (!analyticsData.share) return;

            const share = analyticsData.share.share_analysis;

            // Export share analysis
            const exportContainer = document.getElementById('export-share-analysis');
            if (exportContainer && share.insights) {
                const exportInsights = share.insights.filter(insight => insight.includes('export'));
                exportContainer.innerHTML = exportInsights.slice(0, 3).map(insight => `
                    <div class="mb-2">
                        <small class="text-muted">${insight}</small>
                    </div>
                `).join('');
            }

            // Import share analysis
            const importContainer = document.getElementById('import-share-analysis');
            if (importContainer && share.insights) {
                const importInsights = share.insights.filter(insight => insight.includes('import'));
                importContainer.innerHTML = importInsights.slice(0, 3).map(insight => `
                    <div class="mb-2">
                        <small class="text-muted">${insight}</small>
                    </div>
                `).join('');
            }

            // Commodity share analysis
            const commodityContainer = document.getElementById('commodity-share-analysis');
            if (commodityContainer) {
                commodityContainer.innerHTML = `
                    <div class="text-center">
                        <div class="h6 text-muted">Commodity share analysis data processing in progress</div>
                        <small class="text-muted">Detailed breakdown will be available soon</small>
                    </div>
                `;
            }
        }

        // Render HHI analysis
        function renderHhiAnalysis() {
            if (!analyticsData.hhi || !analyticsData.hhi.hhi) {
                console.error('HHI analysis data not available:', analyticsData.hhi);
                // Show error messages in UI
                const exportContainer = document.getElementById('export-hhi-analysis');
                const importContainer = document.getElementById('import-hhi-analysis');
                const riskContainer = document.getElementById('hhi-risk-assessment');

                const errorHtml = '<div class="text-center py-4"><div class="text-muted">HHI analysis data not available</div></div>';

                if (exportContainer) exportContainer.innerHTML = errorHtml;
                if (importContainer) importContainer.innerHTML = errorHtml;
                if (riskContainer) riskContainer.innerHTML = '<div class="text-center py-4"><div class="text-muted">Risk assessment data not available</div></div>';
                return;
            }

            const hhi = analyticsData.hhi.hhi;

            // Helper function to safely format numbers
            function safeFormat(value, decimals = 4, defaultValue = 'N/A') {
                if (value === null || value === undefined || isNaN(value)) {
                    return defaultValue;
                }
                return Number(value).toFixed(decimals);
            }

            // Export HHI
            const exportContainer = document.getElementById('export-hhi-analysis');
            if (exportContainer) {
                const exportHhiValue = hhi.export_destinations?.hhi_value || 0;
                const exportInterpretation = hhi.export_destinations?.interpretation || 'Unknown';
                const exportCount = hhi.export_destinations?.number_of_destinations || 0;

                exportContainer.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="h3 text-primary">${safeFormat(exportHhiValue)}</div>
                        <p class="mb-1">${exportInterpretation}</p>
                        <small class="text-muted">${exportCount} destinations analyzed</small>
                    </div>
                `;
            }

            // Import HHI
            const importContainer = document.getElementById('import-hhi-analysis');
            if (importContainer) {
                const importHhiValue = hhi.import_sources?.hhi_value || 0;
                const importInterpretation = hhi.import_sources?.interpretation || 'Unknown';
                const importCount = hhi.import_sources?.number_of_sources || 0;

                importContainer.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="h3 text-warning">${safeFormat(importHhiValue)}</div>
                        <p class="mb-1">${importInterpretation}</p>
                        <small class="text-muted">${importCount} sources analyzed</small>
                    </div>
                `;
            }

            // Risk assessment
            const riskContainer = document.getElementById('hhi-risk-assessment');
            if (riskContainer && hhi.insights) {
                riskContainer.innerHTML = hhi.insights.slice(0, 3).map(insight => `
                    <div class="mb-2">
                        <small class="text-muted">${insight}</small>
                    </div>
                `).join('');
            }
        }

        // Render trade balance analysis
        function renderTradeBalanceAnalysis() {
            if (!analyticsData.tradeBalance || !analyticsData.tradeBalance.trade_balance) {
                console.error('Trade balance analysis data not available:', analyticsData.tradeBalance);
                // Show error messages in UI
                const trendsContainer = document.getElementById('balance-trends');
                const driversContainer = document.getElementById('deficit-drivers');

                const errorHtml = '<div class="text-center py-4"><div class="text-muted">Trade balance analysis data not available</div></div>';

                if (trendsContainer) trendsContainer.innerHTML = errorHtml;
                if (driversContainer) driversContainer.innerHTML = '<li class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-muted">Deficit analysis data not available</p></li>';
                return;
            }

            const balance = analyticsData.tradeBalance.trade_balance;

            // Helper function to safely format numbers
            function safeFormat(value, decimals = 1, defaultValue = '0.0') {
                if (value === null || value === undefined || isNaN(value)) {
                    return defaultValue;
                }
                return Number(value).toFixed(decimals);
            }

            // Balance trends
            const trendsContainer = document.getElementById('balance-trends');
            if (trendsContainer && balance.deficit_drivers) {
                const avgDeficit = balance.deficit_drivers.average_deficit || 0;
                const quartersInDeficit = balance.deficit_drivers.quarters_in_deficit || 0;

                trendsContainer.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="h4 text-danger">$${safeFormat(avgDeficit)}M</div>
                        <p class="mb-1">Average Quarterly Deficit</p>
                        <small class="text-muted">${quartersInDeficit} quarters with deficit</small>
                    </div>
                `;
            }

            // Deficit drivers
            const driversContainer = document.getElementById('deficit-drivers');
            if (driversContainer && balance.insights) {
                driversContainer.innerHTML = balance.insights.slice(0, 5).map(insight => `
                    <li class="insight-item">
                        <div class="insight-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="insight-content">
                            <p class="mb-0">${insight}</p>
                        </div>
                    </li>
                `).join('');
            }
        }

        // Render correlation analysis
        function renderCorrelationAnalysis() {
            if (!analyticsData.correlations || !analyticsData.correlations.correlations) {
                console.error('Correlation analysis data not available:', analyticsData.correlations);
                // Show error messages in UI
                const matrixContainer = document.getElementById('correlation-matrix');
                const insightsContainer = document.getElementById('correlation-insights');

                const errorHtml = '<div class="text-center py-4"><div class="text-muted">Correlation analysis data not available</div></div>';

                if (matrixContainer) matrixContainer.innerHTML = errorHtml;
                if (insightsContainer) insightsContainer.innerHTML = '<li class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="mt-2 text-muted">Correlation insights data not available</p></li>';
                return;
            }

            const corr = analyticsData.correlations.correlations;

            // Correlation matrix - proper table format
            const matrixContainer = document.getElementById('correlation-matrix');
            if (matrixContainer && corr.matrix) {
                const variables = Object.keys(corr.matrix);
                const variableLabels = {
                    'exports': 'Exports',
                    'imports': 'Imports',
                    'trade_balance': 'Trade Balance'
                };

                // Create correlation matrix table
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="correlation-table">
                            <thead>
                                <tr>
                                    <th class="correlation-header">Variables</th>
                                    ${variables.map(varName => `<th class="correlation-header">${variableLabels[varName] || varName}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                variables.forEach(var1 => {
                    tableHtml += `<tr><td class="correlation-row-header">${variableLabels[var1] || var1}</td>`;
                    variables.forEach(var2 => {
                        const value = corr.matrix[var1][var2];
                        const intensity = Math.abs(value);
                        let bgClass = 'correlation-low';
                        let textClass = 'text-dark';

                        if (intensity > 0.7) {
                            bgClass = 'correlation-high';
                            textClass = 'text-white';
                        } else if (intensity > 0.3) {
                            bgClass = 'correlation-medium';
                            textClass = 'text-white';
                        }

                        // Special styling for diagonal (always 1.0)
                        if (var1 === var2) {
                            bgClass = 'correlation-diagonal';
                            textClass = 'text-white font-weight-bold';
                        }

                        tableHtml += `<td class="correlation-cell ${bgClass} ${textClass}" title="${variableLabels[var1] || var1} vs ${variableLabels[var2] || var2}: ${value.toFixed(3)}">${value.toFixed(3)}</td>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-center">
                        <div class="correlation-legend">
                            <div class="legend-item">
                                <span class="legend-color correlation-high"></span>
                                <span>Strong correlation (>0.7)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color correlation-medium"></span>
                                <span>Medium correlation (0.3-0.7)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color correlation-low"></span>
                                <span>Weak correlation (<0.3)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color correlation-diagonal"></span>
                                <span>Perfect correlation (1.0)</span>
                            </div>
                        </div>
                    </div>
                `;

                matrixContainer.innerHTML = tableHtml;
            }

            // Correlation insights
            const insightsContainer = document.getElementById('correlation-insights');
            if (insightsContainer && corr.strong_relationships) {
                insightsContainer.innerHTML = corr.strong_relationships.slice(0, 5).map(rel => `
                    <li class="insight-item">
                        <div class="insight-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="insight-content">
                            <p class="mb-0">${rel.interpretation}</p>
                            <small class="text-muted">r = ${rel.correlation.toFixed(3)}</small>
                        </div>
                    </li>
                `).join('');
            }
        }

        // Render AI recommendations
        function renderAIRecommendations() {
            const container = document.getElementById('ai-recommendations');
            if (!container) return;

            const recommendations = [
                {
                    icon: 'fas fa-diversity-3',
                    title: 'Diversify Export Markets',
                    description: 'Reduce dependency on UAE by expanding to emerging markets in Asia and Europe',
                    priority: 'High',
                    impact: 'Strategic'
                },
                {
                    icon: 'fas fa-industry',
                    title: 'Focus on Value-Added Exports',
                    description: 'Shift from raw commodities to processed goods to improve trade balance',
                    priority: 'High',
                    impact: 'Economic'
                },
                {
                    icon: 'fas fa-handshake',
                    title: 'Strengthen Regional Trade',
                    description: 'Leverage EAC opportunities, particularly with DRC for re-exports',
                    priority: 'Medium',
                    impact: 'Regional'
                },
                {
                    icon: 'fas fa-chart-line',
                    title: 'Monitor Import Trends',
                    description: 'Track machinery and fuel imports for potential cost-saving measures',
                    priority: 'Medium',
                    impact: 'Operational'
                },
                {
                    icon: 'fas fa-robot',
                    title: 'Implement Predictive Analytics',
                    description: 'Use forecasting models for better trade policy planning',
                    priority: 'Low',
                    impact: 'Technological'
                },
                {
                    icon: 'fas fa-balance-scale',
                    title: 'Address Trade Deficit',
                    description: 'Develop strategies to reduce structural trade imbalance',
                    priority: 'High',
                    impact: 'Economic'
                }
            ];

            container.innerHTML = `
                <div class="analysis-grid">
                    ${recommendations.map(rec => `
                        <div class="analysis-card">
                            <div class="d-flex align-items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="${rec.icon}"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <h6 class="mb-0">${rec.title}</h6>
                                        <span class="badge bg-${rec.priority === 'High' ? 'danger' : rec.priority === 'Medium' ? 'warning' : 'secondary'}">${rec.priority}</span>
                                    </div>
                                    <p class="mb-2 text-muted small">${rec.description}</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <small class="text-muted">
                                            <i class="fas fa-bullseye me-1"></i>${rec.impact} Impact
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Auto-load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Advanced Analytics Dashboard initialized');
            loadAnalyticsData();
        });

        // Make functions globally available
        window.loadAnalyticsData = loadAnalyticsData;

        // Explanation modal functions
        function showExplanation(analysisType) {
            try {
                // Prevent multiple rapid clicks
                if (window.explanationLoading) {
                    return;
                }
                window.explanationLoading = true;

                const modal = document.getElementById('explanationModalOverlay');
                const modalContent = document.getElementById('explanationModal');
                const content = document.getElementById('explanationContent');
                const aiContent = document.getElementById('aiInsightsContent');
                const title = document.getElementById('explanationModalLabel');

                if (!modal || !content || !aiContent || !title) {
                    console.error('Modal elements not found');
                    window.explanationLoading = false;
                    return;
                }

                // Generate content synchronously to prevent UI freeze
                try {
                    let explanationHtml = '';
                    let modalTitle = '';

                    switch(analysisType) {
                        case 'time-series':
                            modalTitle = '<i class="fas fa-chart-line me-2"></i>Understanding Time Series Analysis';
                            explanationHtml = generateSimpleExplanation('time-series');
                            break;
                        case 'forecasting':
                            modalTitle = '<i class="fas fa-magic me-2"></i>Understanding Trade Forecasting';
                            explanationHtml = generateSimpleExplanation('forecasting');
                            break;
                        case 'growth':
                            modalTitle = '<i class="fas fa-chart-bar me-2"></i>Understanding Growth Analysis';
                            explanationHtml = generateSimpleExplanation('growth');
                            break;
                        case 'share':
                            modalTitle = '<i class="fas fa-pie-chart me-2"></i>Understanding Share Analysis';
                            explanationHtml = generateSimpleExplanation('share');
                            break;
                        case 'hhi':
                            modalTitle = '<i class="fas fa-balance-scale me-2"></i>Understanding HHI Analysis';
                            explanationHtml = generateSimpleExplanation('hhi');
                            break;
                        case 'balance':
                            modalTitle = '<i class="fas fa-balance-scale me-2"></i>Understanding Trade Balance Analysis';
                            explanationHtml = generateSimpleExplanation('balance');
                            break;
                        case 'correlation':
                            modalTitle = '<i class="fas fa-link me-2"></i>Understanding Correlation Analysis';
                            explanationHtml = generateSimpleExplanation('correlation');
                            break;
                        default:
                            modalTitle = '<i class="fas fa-question-circle me-2"></i>Analysis Explanation';
                            explanationHtml = '<div class="alert alert-info"><h6>Analysis Type Not Found</h6><p>The requested analysis explanation is not available.</p></div>';
                    }

                    title.innerHTML = modalTitle;
                    content.innerHTML = explanationHtml;

                    // Reset AI insights panel to initial state
                    resetAIInsightsPanel();

                    // Show modal
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling

                } catch (error) {
                    console.error('Error generating explanation:', error);
                    title.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Explanation Error</h6>
                            <p>Sorry, there was an error generating the explanation. Please try again.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    `;
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } finally {
                    window.explanationLoading = false;
                }

            } catch (error) {
                console.error('Error in showExplanation:', error);
                window.explanationLoading = false;
            }
        }

        // Reset AI insights panel to initial state
        function resetAIInsightsPanel() {
            const generateBtn = document.getElementById('generateInsightBtn');
            const loadingSpinner = document.getElementById('aiLoadingSpinner');
            const loadingText = document.getElementById('aiLoadingText');
            const loadingSubtext = document.getElementById('aiLoadingSubtext');
            const insightsDisplay = document.getElementById('aiInsightsDisplay');

            if (generateBtn) generateBtn.classList.remove('d-none');
            if (loadingSpinner) loadingSpinner.classList.add('d-none');
            if (loadingText) loadingText.classList.add('d-none');
            if (loadingSubtext) loadingSubtext.classList.add('d-none');
            if (insightsDisplay) insightsDisplay.classList.add('d-none');
        }

        // Simple markdown to HTML converter
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Convert headers (### Header -> <h4>Header</h4>)
            html = html.replace(/^### (.+)$/gm, '<h4 class="text-primary mt-3 mb-2">$1</h4>');

            // Convert bold text (**text** -> <strong>text</strong>)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert bullet points (- item -> â€¢ item)
            html = html.replace(/^- (.+)$/gm, '<span class="bullet-point">â€¢ $1</span><br>');

            // Convert line breaks
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Generate AI insights when button is clicked
        async function generateAIInsights() {
            const generateBtn = document.getElementById('generateInsightBtn');
            const loadingSpinner = document.getElementById('aiLoadingSpinner');
            const loadingText = document.getElementById('aiLoadingText');
            const loadingSubtext = document.getElementById('aiLoadingSubtext');
            const insightsDisplay = document.getElementById('aiInsightsDisplay');
            const insightsList = document.getElementById('insightsList');
            const generatedTime = document.getElementById('generatedTime');

            // Get current section from modal title or URL/state
            const modalTitle = document.getElementById('explanationModalLabel');
            let currentSection = 'time-series'; // default
            let sectionData = null;

            if (modalTitle) {
                const titleText = modalTitle.textContent.toLowerCase();
                if (titleText.includes('time series')) {
                    currentSection = 'time-series';
                    sectionData = analyticsData.timeSeries;
                }
                else if (titleText.includes('forecasting')) {
                    currentSection = 'forecasting';
                    sectionData = analyticsData.timeSeries; // Forecasting data is in timeSeries
                }
                else if (titleText.includes('growth')) {
                    currentSection = 'growth';
                    sectionData = analyticsData.growth;
                }
                else if (titleText.includes('share')) {
                    currentSection = 'share';
                    sectionData = analyticsData.share;
                }
                else if (titleText.includes('hhi')) {
                    currentSection = 'hhi';
                    sectionData = analyticsData.hhi;
                }
                else if (titleText.includes('balance')) {
                    currentSection = 'balance';
                    sectionData = analyticsData.tradeBalance;
                }
                else if (titleText.includes('correlation')) {
                    currentSection = 'correlation';
                    sectionData = analyticsData.correlations;
                }
            }

            try {
                // Show loading state
                if (generateBtn) generateBtn.classList.add('d-none');
                if (loadingSpinner) loadingSpinner.classList.remove('d-none');
                if (loadingText) loadingText.classList.remove('d-none');
                if (loadingSubtext) loadingSubtext.classList.remove('d-none');
                if (insightsDisplay) insightsDisplay.classList.add('d-none');

                // Fetch AI insights from the API with section data
                const response = await fetch('/api/analytics/ai-insights/' + currentSection, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sectionData: sectionData,
                        section: currentSection
                    })
                });
                const data = await response.json();

                if ((data.success && data.insights) || (!data.success && data.insights)) {
                    // Format insights as a clean list - show insights even if success is false
                    const insightsArray = Array.isArray(data.insights) ? data.insights : [data.insights];
                    const insightsHtml = insightsArray.map(insight =>
                        '<div class="insight-item mb-3">' +
                            '<div class="insight-icon"><i class="fas fa-lightbulb"></i></div>' +
                            '<div class="insight-content"><p class="mb-0">' + markdownToHtml(insight) + '</p></div>' +
                        '</div>'
                    ).join('');

                    if (insightsList) insightsList.innerHTML = insightsHtml;
                    if (generatedTime) generatedTime.textContent = new Date(data.generated_at).toLocaleString();

                    // Show a note if this is fallback data
                    if (!data.success && data.using_huggingface === false) {
                        const fallbackNote = document.createElement('div');
                        fallbackNote.className = 'alert alert-info mt-3';
                        fallbackNote.innerHTML = '<small><i class="fas fa-info-circle me-1"></i>Showing professional insights while AI service is being updated.</small>';
                        if (insightsList) insightsList.appendChild(fallbackNote);
                    }

                } else {
                    // Show error only if no insights are available at all
                    if (insightsList) {
                        insightsList.innerHTML = '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle me-2"></i>AI Insights Unavailable</h6><p>Unable to generate insights at this time. Please try again later.</p>' + (data.error ? '<small class="text-muted mt-2 d-block">Error: ' + data.error + '</small>' : '') + '</div>';
                    }
                }

                // Show results
                if (insightsDisplay) insightsDisplay.classList.remove('d-none');

            } catch (error) {
                console.error('Error generating AI insights:', error);

                // Show error state
                if (insightsList) {
                    insightsList.innerHTML = '<div class="alert alert-danger"><h6><i class="fas fa-exclamation-triangle me-2"></i>Failed to Generate AI Insights</h6><p>There was an error connecting to the AI service. Please check your internet connection and try again.</p><small class="text-muted">Error: ' + error.message + '</small></div>';
                }
                if (insightsDisplay) insightsDisplay.classList.remove('d-none');

            } finally {
                // Hide loading state
                if (loadingSpinner) loadingSpinner.classList.add('d-none');
                if (loadingText) loadingText.classList.add('d-none');
                if (loadingSubtext) loadingSubtext.classList.add('d-none');
                if (generateBtn) generateBtn.classList.remove('d-none');
            }
        }

        function closeExplanationModal() {
            const modal = document.getElementById('explanationModalOverlay');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('explanationModalOverlay');
            if (event.target === modal) {
                closeExplanationModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('explanationModalOverlay');
                if (modal && modal.style.display === 'flex') {
                    closeExplanationModal();
                }
            }
        });

        // Simple explanation generator - lightweight and fast
        function generateSimpleExplanation(type) {
            const explanations = {
                'time-series': {
                    title: 'Time Series Analysis',
                    what: 'Examines data patterns over time to identify trends, seasonality, and predict future behavior.',
                    key_concepts: ['Trend Analysis', 'Seasonality Detection', 'Stationarity Tests', 'Forecasting Models'],
                    policy_value: 'Helps policymakers understand trade evolution and plan for future scenarios.',
                    data_needed: 'Historical trade data over multiple time periods'
                },
                'forecasting': {
                    title: 'Trade Forecasting',
                    what: 'Uses statistical models to predict future trade values based on historical patterns.',
                    key_concepts: ['Exponential Smoothing', 'Trend Projection', 'Seasonal Adjustment', 'Confidence Intervals'],
                    policy_value: 'Enables proactive policy planning and resource allocation for trade promotion.',
                    data_needed: 'Time series data with sufficient historical periods'
                },
                'growth': {
                    title: 'Growth Analysis',
                    what: 'Measures how trade values change over time using various growth metrics.',
                    key_concepts: ['CAGR (Compound Annual Growth)', 'Quarter-over-Quarter', 'Year-over-Year', 'Growth Rates'],
                    policy_value: 'Identifies acceleration/deceleration in trade performance for policy adjustment.',
                    data_needed: 'Multi-period trade data for comparison'
                },
                'share': {
                    title: 'Share Analysis',
                    what: 'Shows the proportion of total trade accounted for by different markets and products.',
                    key_concepts: ['Market Concentration', 'Product Distribution', 'Geographic Shares', 'Diversification Metrics'],
                    policy_value: 'Identifies market concentration risks and diversification opportunities.',
                    data_needed: 'Trade data by country, region, and commodity'
                },
                'hhi': {
                    title: 'HHI Concentration Index',
                    what: 'Measures market concentration using the Herfindahl-Hirschman Index formula.',
                    key_concepts: ['Market Concentration', 'Competition Analysis', 'Risk Assessment', 'Diversification Index'],
                    policy_value: 'Assesses economic vulnerability from over-reliance on single markets.',
                    data_needed: 'Market share data by trading partner'
                },
                'balance': {
                    title: 'Trade Balance Analysis',
                    what: 'Examines the difference between exports and imports over time.',
                    key_concepts: ['Trade Deficit/Surplus', 'Balance Trends', 'Structural Imbalances', 'Economic Impact'],
                    policy_value: 'Monitors trade balance health and identifies structural trade issues.',
                    data_needed: 'Export and import values over time'
                },
                'correlation': {
                    title: 'Correlation Analysis',
                    what: 'Measures relationships between different trade variables.',
                    key_concepts: ['Variable Relationships', 'Correlation Matrix', 'Dependency Analysis', 'Causality Indicators'],
                    policy_value: 'Understands how trade variables interact for coordinated policy making.',
                    data_needed: 'Multiple trade variables for statistical comparison'
                }
            };

            const exp = explanations[type];
            if (!exp) {
                return '<div class="alert alert-warning">Explanation not available for this analysis type.</div>';
            }

            return `
                <div class="explanation-content">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>What is ${exp.title}?</h6>
                        <p>${exp.what}</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-cogs me-2"></i>Key Concepts</h6>
                            <ul class="list-unstyled">
                                ${exp.key_concepts.map(concept => `<li><i class="fas fa-check-circle text-success me-2"></i>${concept}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info"><i class="fas fa-chart-line me-2"></i>Policy Value</h6>
                            <p class="small">${exp.policy_value}</p>

                            <h6 class="text-secondary mt-3"><i class="fas fa-database me-2"></i>Data Requirements</h6>
                            <p class="small text-muted">${exp.data_needed}</p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Current Status</h6>
                        <div class="alert alert-light">
                            <p class="mb-1"><strong>Data Loading:</strong> ${analyticsData ? 'Available' : 'Loading...'}</p>
                            <p class="mb-0"><strong>Analysis Ready:</strong> ${analyticsData && analyticsData[type] ? 'Yes' : 'Waiting for data'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateForecastingExplanation() {
            if (!analyticsData.timeSeries || !analyticsData.timeSeries.time_series) {
                return '<div class="alert alert-warning">Forecasting data not available for explanation.</div>';
            }

            const ts = analyticsData.timeSeries.time_series;
            const exportForecast = ts.forecast_next_4_quarters?.exports?.forecast_values || [];
            const importForecast = ts.forecast_next_4_quarters?.imports?.forecast_values || [];

            return `
                <div class="explanation-content">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-magic me-2"></i>What is Trade Forecasting?</h6>
                        <p>Trade forecasting uses statistical models to predict future trade values based on historical patterns. This helps policymakers plan ahead and make informed decisions about trade policies and resource allocation.</p>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fas fa-arrow-trend-up me-2"></i>Export Forecast (Next 4 Quarters)</h6>
                            <div class="forecast-preview">
                                ${exportForecast.map((value, index) =>
                                    `<div class="forecast-item-small">
                                        <span>Q${index + 1} 2026:</span>
                                        <strong>$${value.toFixed(1)}M</strong>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-arrow-trend-down me-2"></i>Import Forecast (Next 4 Quarters)</h6>
                            <div class="forecast-preview">
                                ${importForecast.map((value, index) =>
                                    `<div class="forecast-item-small">
                                        <span>Q${index + 1} 2026:</span>
                                        <strong>$${value.toFixed(1)}M</strong>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                        <ul class="policy-points">
                            <li><strong>Resource Planning:</strong> Use these forecasts to plan budget allocations for trade promotion activities</li>
                            <li><strong>Risk Management:</strong> Anticipate potential trade imbalances and prepare mitigation strategies</li>
                            <li><strong>Policy Timing:</strong> Time policy interventions based on forecasted trends rather than reacting to events</li>
                            <li><strong>Stakeholder Communication:</strong> Share reliable forecasts with private sector for better planning</li>
                        </ul>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="text-muted"><i class="fas fa-cog me-2"></i>Forecasting Method</h6>
                        <p class="small mb-0">These forecasts use Exponential Smoothing, a proven statistical method that gives more weight to recent data while considering seasonal patterns. The model has been validated against historical data to ensure reliability.</p>
                    </div>
                </div>
            `;
        }

        function generateGrowthExplanation() {
            try {
                if (!analyticsData || !analyticsData.growth || !analyticsData.growth.growth_analysis) {
                    return `
                        <div class="explanation-content">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-chart-bar me-2"></i>What is Growth Analysis?</h6>
                                <p>Growth analysis measures how trade values change over time using different time periods: Quarter-over-Quarter (QoQ), Year-over-Year (YoY), and Compound Annual Growth Rate (CAGR). This helps identify acceleration or deceleration in trade performance.</p>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock me-2"></i>Growth Data Not Available</h6>
                                <p>The growth analysis data is still loading. Please wait for the analytics data to load completely.</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Expected Data:</strong> CAGR calculations, QoQ and YoY growth rates, trend analysis
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const growth = analyticsData.growth.growth_analysis;
                const exportsCagr = growth.cagr?.exports || 0;
                const importsCagr = growth.cagr?.imports || 0;

                return `
                    <div class="explanation-content">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-bar me-2"></i>What is Growth Analysis?</h6>
                            <p>Growth analysis measures how trade values change over time using different time periods: Quarter-over-Quarter (QoQ), Year-over-Year (YoY), and Compound Annual Growth Rate (CAGR). This helps identify acceleration or deceleration in trade performance.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="fas fa-percentage me-2"></i>Export Growth Metrics</h6>
                                <div class="metric-highlight">
                                    <strong>CAGR:</strong> ${exportsCagr.toFixed(1)}% annual growth
                                    <br><strong>Trend:</strong> <span class="badge bg-${exportsCagr > 0 ? 'success' : 'danger'}">${exportsCagr > 0 ? 'Growing' : 'Declining'}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-percentage me-2"></i>Import Growth Metrics</h6>
                                <div class="metric-highlight">
                                    <strong>CAGR:</strong> ${importsCagr.toFixed(1)}% annual growth
                                    <br><strong>Trend:</strong> <span class="badge bg-${importsCagr > 0 ? 'success' : 'danger'}">${importsCagr > 0 ? 'Growing' : 'Declining'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                            <ul class="policy-points">
                                <li><strong>Growth Sustainability:</strong> ${exportsCagr > 0 ? 'Positive export CAGR indicates sustainable growth trajectory' : 'Negative export CAGR requires urgent policy intervention'}</li>
                                <li><strong>Comparative Performance:</strong> ${exportsCagr > importsCagr ? 'Export growth outpacing imports is favorable for trade balance' : 'Import growth exceeding exports may worsen trade deficit'}</li>
                                <li><strong>Volatility Assessment:</strong> High QoQ variations suggest need for stabilization policies</li>
                                <li><strong>Long-term Planning:</strong> CAGR provides reliable metric for multi-year strategic planning</li>
                            </ul>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="text-muted"><i class="fas fa-calculator me-2"></i>Understanding CAGR</h6>
                            <p class="small mb-0">CAGR measures the mean annual growth rate over a specified time period longer than one year. It represents one of the most accurate ways to calculate and determine returns for anything that can rise or fall in value over time.</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating growth explanation:', error);
                return `
                    <div class="explanation-content">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Growth Explanation</h6>
                            <p>There was an error generating the growth analysis explanation. Please try again later.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        function generateShareExplanation() {
            try {
                if (!analyticsData || !analyticsData.share || !analyticsData.share.share_analysis) {
                    return `
                        <div class="explanation-content">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-pie-chart me-2"></i>What is Share Analysis?</h6>
                                <p>Share analysis shows the proportion of total trade accounted for by different countries, regions, and commodities. It helps identify market concentration and diversification opportunities.</p>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock me-2"></i>Share Analysis Data Not Available</h6>
                                <p>The share analysis data is still loading. Please wait for the analytics data to load completely.</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Expected Data:</strong> Country and commodity share percentages, market concentration analysis
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const share = analyticsData.share.share_analysis;
                const topExport = Object.entries(share.country_share?.exports || {})
                    .sort((a, b) => b[1].share_percentage - a[1].share_percentage)[0];

                return `
                    <div class="explanation-content">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-pie-chart me-2"></i>What is Share Analysis?</h6>
                            <p>Share analysis shows the proportion of total trade accounted for by different countries, regions, and commodities. It helps identify market concentration and diversification opportunities.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-globe me-2"></i>Export Market Concentration</h6>
                                <div class="metric-highlight">
                                    <strong>Top Destination:</strong> ${topExport ? topExport[0] : 'N/A'}
                                    <br><strong>Market Share:</strong> ${topExport ? topExport[1].share_percentage.toFixed(1) : '0.0'}%
                                </div>
                                <p class="mt-2 small text-muted">
                                    ${topExport && topExport[1].share_percentage > 50 ?
                                        'High concentration in single market indicates vulnerability to destination-specific risks.' :
                                        'Reasonable market diversification reduces dependency risks.'}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="fas fa-box me-2"></i>Commodity Distribution</h6>
                                <div class="metric-highlight">
                                    <strong>Analysis:</strong> Product diversification assessment
                                    <br><strong>Focus:</strong> Key export commodities identification
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                            <ul class="policy-points">
                                <li><strong>Market Diversification:</strong> High concentration in few markets increases economic vulnerability</li>
                                <li><strong>Export Promotion:</strong> Target emerging markets to reduce dependency on traditional partners</li>
                                <li><strong>Product Development:</strong> Focus on high-value commodities with growth potential</li>
                                <li><strong>Risk Management:</strong> Develop contingency plans for major trading partner disruptions</li>
                            </ul>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating share explanation:', error);
                return `
                    <div class="explanation-content">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Share Explanation</h6>
                            <p>There was an error generating the share analysis explanation. Please try again later.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        function generateHHIExplanation() {
            try {
                if (!analyticsData || !analyticsData.hhi || !analyticsData.hhi.hhi) {
                    return `
                        <div class="explanation-content">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-balance-scale me-2"></i>What is HHI (Herfindahl-Hirschman Index)?</h6>
                                <p>HHI measures market concentration by summing the squares of market shares. Higher values indicate greater concentration (less competition). Values above 0.25 suggest highly concentrated markets.</p>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock me-2"></i>HHI Analysis Data Not Available</h6>
                                <p>The HHI concentration analysis data is still loading. Please wait for the analytics data to load completely.</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Expected Data:</strong> Market concentration indices, diversification analysis, risk assessments
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const hhi = analyticsData.hhi.hhi;
                const exportHhi = hhi.export_destinations?.hhi_value || 0;
                const importHhi = hhi.import_sources?.hhi_value || 0;

                return `
                    <div class="explanation-content">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-balance-scale me-2"></i>What is HHI (Herfindahl-Hirschman Index)?</h6>
                            <p>HHI measures market concentration by summing the squares of market shares. Higher values indicate greater concentration (less competition). Values above 0.25 suggest highly concentrated markets.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-arrow-up me-2"></i>Export Market Concentration</h6>
                                <div class="metric-highlight">
                                    <strong>HHI Value:</strong> ${exportHhi.toFixed(4)}
                                    <br><strong>Interpretation:</strong> ${hhi.export_destinations?.interpretation || 'Unknown'}
                                    <br><strong>Markets:</strong> ${hhi.export_destinations?.number_of_destinations || 0} destinations
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-danger"><i class="fas fa-arrow-down me-2"></i>Import Market Concentration</h6>
                                <div class="metric-highlight">
                                    <strong>HHI Value:</strong> ${importHhi.toFixed(4)}
                                    <br><strong>Interpretation:</strong> ${hhi.import_sources?.interpretation || 'Unknown'}
                                    <br><strong>Sources:</strong> ${hhi.import_sources?.number_of_sources || 0} sources
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                            <ul class="policy-points">
                                <li><strong>Risk Assessment:</strong> ${exportHhi > 0.25 ? 'High export concentration indicates significant vulnerability to market shocks' : 'Export markets show reasonable diversification'}</li>
                                <li><strong>Supply Chain Security:</strong> ${importHhi > 0.25 ? 'High import concentration creates supply chain vulnerabilities' : 'Import sources are reasonably diversified'}</li>
                                <li><strong>Policy Priority:</strong> Focus on diversifying both export destinations and import sources</li>
                                <li><strong>Economic Stability:</strong> Lower HHI values contribute to more stable trade relationships</li>
                            </ul>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="text-muted"><i class="fas fa-scale-balanced me-2"></i>HHI Scale Interpretation</h6>
                            <ul class="small mb-0">
                                <li><strong>0.00 - 0.15:</strong> Unconcentrated market (good diversification)</li>
                                <li><strong>0.15 - 0.25:</strong> Moderately concentrated</li>
                                <li><strong>0.25+:</strong> Highly concentrated (high risk)</li>
                            </ul>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating HHI explanation:', error);
                return `
                    <div class="explanation-content">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading HHI Explanation</h6>
                            <p>There was an error generating the HHI analysis explanation. Please try again later.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        function generateBalanceExplanation() {
            try {
                if (!analyticsData || !analyticsData.tradeBalance || !analyticsData.tradeBalance.trade_balance) {
                    return `
                        <div class="explanation-content">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-balance-scale me-2"></i>What is Trade Balance Analysis?</h6>
                                <p>Trade balance analysis examines the difference between exports and imports. A positive balance (surplus) occurs when exports exceed imports, while a negative balance (deficit) occurs when imports exceed exports.</p>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock me-2"></i>Trade Balance Data Not Available</h6>
                                <p>The trade balance analysis data is still loading. Please wait for the analytics data to load completely.</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Expected Data:</strong> Balance trends, deficit analysis, structural trade components
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const balance = analyticsData.tradeBalance.trade_balance;
                const avgDeficit = balance.deficit_drivers?.average_deficit || 0;
                const quartersDeficit = balance.deficit_drivers?.quarters_in_deficit || 0;

                return `
                    <div class="explanation-content">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-balance-scale me-2"></i>What is Trade Balance Analysis?</h6>
                            <p>Trade balance analysis examines the difference between exports and imports. A positive balance (surplus) occurs when exports exceed imports, while a negative balance (deficit) occurs when imports exceed exports.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger"><i class="fas fa-chart-area me-2"></i>Balance Overview</h6>
                                <div class="metric-highlight">
                                    <strong>Average Deficit:</strong> $${avgDeficit.toFixed(0)}M per quarter
                                    <br><strong>Deficit Quarters:</strong> ${quartersDeficit} out of 9 analyzed
                                    <br><strong>Deficit Rate:</strong> ${((quartersDeficit / 9) * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-search-dollar me-2"></i>Structural Issues</h6>
                                <div class="metric-highlight">
                                    <strong>Analysis:</strong> Persistent trade deficit
                                    <br><strong>Drivers:</strong> Import volume vs export capacity
                                    <br><strong>Trend:</strong> Structural imbalance requiring policy attention
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                            <ul class="policy-points">
                                <li><strong>Economic Impact:</strong> Persistent trade deficits can lead to foreign exchange pressure and economic instability</li>
                                <li><strong>Export Promotion:</strong> Urgent need for policies to boost export competitiveness and volume</li>
                                <li><strong>Import Management:</strong> Review import policies to balance necessary imports with domestic production</li>
                                <li><strong>Structural Reforms:</strong> Address underlying factors causing the trade imbalance</li>
                                <li><strong>Monitoring:</strong> Regular balance monitoring essential for economic stability</li>
                            </ul>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="text-muted"><i class="fas fa-chart-line me-2"></i>Economic Significance</h6>
                            <p class="small mb-0">Trade balance is a key economic indicator. Persistent deficits may require foreign borrowing, while surpluses can strengthen currency and provide economic stability. Rwanda's trade balance directly impacts GDP, employment, and economic growth prospects.</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating balance explanation:', error);
                return `
                    <div class="explanation-content">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Balance Explanation</h6>
                            <p>There was an error generating the trade balance analysis explanation. Please try again later.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }

        function generateCorrelationExplanation() {
            try {
                if (!analyticsData || !analyticsData.correlations || !analyticsData.correlations.correlations) {
                    return `
                        <div class="explanation-content">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-link me-2"></i>What is Correlation Analysis?</h6>
                                <p>Correlation analysis measures the relationship between trade variables. Values range from -1 (perfect negative correlation) to +1 (perfect positive correlation). Zero indicates no relationship.</p>
                            </div>
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-clock me-2"></i>Correlation Analysis Data Not Available</h6>
                                <p>The correlation analysis data is still loading. Please wait for the analytics data to load completely.</p>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Expected Data:</strong> Variable relationships, correlation matrix, dependency analysis
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const corr = analyticsData.correlations.correlations;
                const matrix = corr.matrix || {};
                const expImpCorr = matrix['exports']?.['imports'] || 0;

                return `
                    <div class="explanation-content">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-link me-2"></i>What is Correlation Analysis?</h6>
                            <p>Correlation analysis measures the relationship between trade variables. Values range from -1 (perfect negative correlation) to +1 (perfect positive correlation). Zero indicates no relationship.</p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-chart-line me-2"></i>Key Relationships</h6>
                                <div class="metric-highlight">
                                    <strong>Exports vs Imports:</strong> ${expImpCorr.toFixed(3)}
                                    <br><strong>Relationship:</strong> ${Math.abs(expImpCorr) > 0.7 ? 'Strong' : Math.abs(expImpCorr) > 0.3 ? 'Moderate' : 'Weak'}
                                    <br><strong>Direction:</strong> ${expImpCorr > 0 ? 'Positive' : 'Negative'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary"><i class="fas fa-table me-2"></i>Correlation Matrix</h6>
                                <div class="correlation-preview">
                                    <small>Complete correlation analysis available in the main dashboard</small>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Policy Implications</h6>
                            <ul class="policy-points">
                                <li><strong>Trade Synchronization:</strong> ${Math.abs(expImpCorr) > 0.5 ? 'Exports and imports move together, suggesting coordinated trade policies needed' : 'Exports and imports show independent behavior, allowing targeted interventions'}</li>
                                <li><strong>Economic Planning:</strong> Understanding variable relationships helps predict economic impacts of policy changes</li>
                                <li><strong>Risk Assessment:</strong> Strong correlations indicate potential ripple effects from policy interventions</li>
                                <li><strong>Policy Coordination:</strong> Related variables require coordinated policy approaches</li>
                            </ul>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="text-muted"><i class="fas fa-lightbulb me-2"></i>Correlation Strength Guide</h6>
                            <ul class="small mb-0">
                                <li><strong>0.00 - 0.30:</strong> Weak correlation (little relationship)</li>
                                <li><strong>0.30 - 0.70:</strong> Moderate correlation (noticeable relationship)</li>
                                <li><strong>0.70 - 1.00:</strong> Strong correlation (tight relationship)</li>
                            </ul>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error generating correlation explanation:', error);
                return `
                    <div class="explanation-content">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Correlation Explanation</h6>
                            <p>There was an error generating the correlation analysis explanation. Please try again later.</p>
                            <small class="text-muted">Error: ${error.message}</small>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
